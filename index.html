<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Agenda HackTown 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, sans-serif; margin: 2em; background: #f8f8fb; color: #222; }
    h1 { font-size: 2em; }
    .controls { margin-bottom: 2em; }
    label { margin-right: 1em; }
    .day { margin-top: 2em; }
    .event { margin-bottom: .8em; padding: .7em 1em; background: #fff; border-radius: 7px; box-shadow: 0 2px 8px #0001; cursor: pointer; transition: background 0.15s; }
    .event:hover { background: #f0f3ff; }
    .event-title { font-weight: bold; }
    .event-place { color: #006; font-size: .95em; }
    select {
      font-size: 1em;
      padding: 0.3em 0.6em;
      border-radius: 5px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      min-width: 0;
      flex: 1 1 0;
    }
    button {
      font-size: 1em;
      padding: 0.5em 1em;
      border-radius: 5px;
      border: none;
      background: #0056cc;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    input[type="text"] {
      font-size: 1em;
      padding: 0.3em 0.6em;
      border-radius: 5px;
      border: 1px solid #ccc;
      min-width: 0;
      flex: 1 1 0;
      box-sizing: border-box;
    }
    input[type="text"]:focus {
      border-color: #0056cc;
      outline: none;
    }
    button:hover {
      background: #003d99;
    }
    #loading { color: #444; font-style: italic; }
    #progress-bar-container {
      width: 100%;
      background: #e0e0e0;
      border-radius: 10px;
      margin-top: 1em;
      margin-bottom: 1em;
      height: 20px;
      display: none;
    }
    #progress-bar {
      height: 100%;
      width: 0%;
      background: #0056cc;
      border-radius: 10px;
      transition: width 0.2s;
    }
    #progress-msg {
      margin-top: 0.4em;
      margin-bottom: 0.8em;
      color: #0056cc;
      font-size: 1em;
      font-weight: bold;
      display: none;
    }
    .search-box {
      margin-bottom: 1em;
      display: flex;
      gap: 0.8em;
      flex-wrap: wrap;
      align-items: center;
    }
    .search-box input[type="text"] {
      width: 230px;
    }
    .filter-row {
      display: flex;
      gap: 0.8em;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 0.7em;
    }
    .filter-row label {
      display: flex;
      align-items: center;
      flex: 1 1 0;
      min-width: 0;
      gap: 0.4em;
    }
    .filter-row select,
    .filter-row input[type="text"] {
      width: 100%;
      min-width: 0;
      flex: 1 1 0;
      box-sizing: border-box;
      max-width: 100%;
    }
    .filter-row button {
      flex-shrink: 0;
    }
    #popupOverlay {
      display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.35); align-items: center; justify-content: center;
    }
    #popup {
      background: #fff; border-radius: 12px; box-shadow: 0 12px 40px #0006;
      padding: 2em; min-width: 320px; max-width: 96vw; max-height: 96vh; overflow-y: auto; position: relative;
      animation: popupFadeIn 0.14s;
      display: flex;
      flex-direction: column;
      gap: 0.6em;
    }
    @keyframes popupFadeIn { from { transform: scale(0.96) translateY(30px); opacity: 0; } to { transform: none; opacity: 1; } }
    .popup-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1em;
    }
    #popupClose {
      font-size: 2em;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
      line-height: 1;
      padding: 0 0.3em;
      margin-left: 1em;
      margin-top: -0.3em;
      flex-shrink: 0;
    }
    .popup-title {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 0.5em;
      margin-top: 0;
      line-height: 1.25;
      flex: 1 1 auto;
      word-break: break-word;
    }
    .popup-time, .popup-place { color: #006; font-size: 1em; margin-bottom: 0.2em; }
    .popup-description { margin: 1em 0; }
    .popup-speakers { margin-top: 1em; }
    .popup-speaker {
      border-top: 1px solid #eee; padding-top: .7em; margin-top: .7em;
      display: flex; align-items: flex-start; gap: 1em;
    }
    .popup-speaker-img {
      width: 48px; height: 48px; border-radius: 50%; object-fit: cover; background: #eee;
      display: inline-block;
    }
    .popup-speaker-info { font-size: .98em; }
    .popup-speaker-name { font-weight: bold; }
    @media (max-width: 600px) {
      body { margin: .7em; }
      .event { padding: .6em; }
      #popup { padding: 1em; min-width: 0; }
      .search-box input { width: 98vw; }
      .popup-title { font-size: 1.1em; }
      #popupClose { font-size: 1.5em; }
      .filter-row {
        flex-direction: column;
        gap: .6em;
      }
      .filter-row label {
        width: 100%;
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <h1>Agenda HackTown 2025</h1>
  <div class="controls">
    <span id="serverStatus"></span>
    <form class="search-box" onsubmit="return false;">
      <input type="text" id="searchInput" placeholder="Filtrar por título, local, palestrante, tag..." autocomplete="off">
    </form>
    <div class="filter-row">
      <label>
        Horário:
        <input type="text" placeholder="ex: 09:00 ou 10:00-12:00" id="timeFilter" size="10">
      </label>
      <label>
        Data:
        <select id="dateFilter"><option value="">Todas as Datas</option></select>
      </label>
      <label>
        Lugar:
        <select id="placeFilter"><option value="">Todos os Lugares</option></select>
      </label>
      <button id="filterBtn">Filtrar</button>
    </div>
  </div>
  <div id="loading">Carregando agenda do servidor...</div>
  <div id="progress-bar-container">
    <div id="progress-bar"></div>
  </div>
  <div id="progress-msg"></div>
  <div id="schedule"></div>
  <!-- Popup Overlay -->
  <div id="popupOverlay">
    <div id="popup">
      <div class="popup-header">
        <div class="popup-title" id="popupTitle"></div>
        <button id="popupClose" title="Fechar">&times;</button>
      </div>
      <div id="popupContent"></div>
    </div>
  </div>
  <script>
    const FIXED_TIMEZONE = "America/Sao_Paulo";

    function parseTimeRange(str) {
      let s = str.trim();
      if (!s) return null;
      if (s.includes('-')) {
        let [start, end] = s.split('-').map(x => x.trim());
        return [start, end];
      } else {
        return [s, s];
      }
    }
    function parseHHMM(s) {
      let [h, m] = s.split(':').map(Number);
      return { h, m };
    }
    function timeObjToMinutes(timeObj) {
      return timeObj.h * 60 + timeObj.m;
    }
    function localTimeToMinutes(d) {
      return d.getHours()*60 + d.getMinutes();
    }

    const diasSemana = ['domingo','segunda-feira','terça-feira','quarta-feira','quinta-feira','sexta-feira','sábado'];
    const mesesAno = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
    function formatarDataPortugues(date) {
      return diasSemana[date.getDay()] + ', ' +
        String(date.getDate()).padStart(2, '0') + ' de ' +
        mesesAno[date.getMonth()] + ' de ' + date.getFullYear();
    }

    let allEvents = [];

    // Async filter control
    let filterTask = null;        // currently running promise
    let pendingFilter = null;     // latest pending params, if any

    function eventMatchesSearch(ev, search) {
      if (!search) return true;
      const q = search.toLowerCase();
      if (ev.title && ev.title.toLowerCase().includes(q)) return true;
      if (ev.place && ev.place.toLowerCase().includes(q)) return true;
      if (ev.speakers && Array.isArray(ev.speakers)) {
        for (const s of ev.speakers) {
          if (s.name && s.name.toLowerCase().includes(q)) return true;
        }
      }
      if (ev.tags && Array.isArray(ev.tags)) {
        for (const t of ev.tags) {
          if (t.name && t.name.toLowerCase().includes(q)) return true;
        }
      }
      if (ev.description && ev.description.toLowerCase().includes(q)) return true;
      return false;
    }

    function render(events, filterTimeRange, filterDayKey, filterPlace, searchText) {
      const scheduleDiv = document.getElementById("schedule");
      document.getElementById("loading").style.display = "none";
      if (!events.length) {
        scheduleDiv.innerHTML = "<p>Nenhum dado carregado.</p>";
        return;
      }

      if (filterPlace) {
        events = events.filter(ev => {
          let place = ev.place && ev.place.trim() ? ev.place.trim() : "sem local definido";
          return place === filterPlace;
        });
      }

      if (searchText && searchText.trim()) {
        events = events.filter(ev => eventMatchesSearch(ev, searchText));
      }

      events = events.slice().sort((a, b) => a.start_time.localeCompare(b.start_time));
      let days = {};
      events.forEach(ev => {
        let localStart = toLocal(ev.start_time, FIXED_TIMEZONE);
        let dayKey = formatarDataPortugues(localStart);
        if (!days[dayKey]) days[dayKey] = [];
        days[dayKey].push(ev);
      });

      if (filterDayKey) {
        for (let day in days) {
          if (day !== filterDayKey) delete days[day];
        }
      }

      if (filterTimeRange) {
        const [startStr, endStr] = filterTimeRange;
        const startObj = parseHHMM(startStr);
        const endObj = parseHHMM(endStr);
        const startMin = timeObjToMinutes(startObj);
        const endMin = timeObjToMinutes(endObj);

        for (let day in days) {
          days[day] = days[day].filter(ev => {
            const startLocal = toLocal(ev.start_time, FIXED_TIMEZONE);
            const endLocal = toLocal(ev.end_time, FIXED_TIMEZONE);
            const evStartMin = localTimeToMinutes(startLocal);
            const evEndMin = localTimeToMinutes(endLocal);

            if (startMin === endMin) {
              return evStartMin <= startMin && startMin < evEndMin;
            } else {
              return !(evEndMin <= startMin || evStartMin >= endMin);
            }
          });
        }
      }

      let html = "";
      for (let day of Object.keys(days).sort((a, b) => {
        let getDate = txt => {
          let partes = txt.split(' ');
          let dia = Number(partes[1]);
          let mes = mesesAno.indexOf(partes[3]);
          let ano = Number(partes[5]);
          return new Date(ano, mes, dia);
        };
        return getDate(a) - getDate(b);
      })) {
        if (!days[day].length) continue;
        html += `<div class="day"><h2>${day.charAt(0).toUpperCase() + day.slice(1)}</h2>`;
        for (let ev of days[day]) {
          let localStart = toLocal(ev.start_time, FIXED_TIMEZONE);
          let localEnd = toLocal(ev.end_time, FIXED_TIMEZONE);
          let startStr = localStart.toLocaleTimeString('pt-BR', { hour: "2-digit", minute: "2-digit" });
          let endStr = localEnd.toLocaleTimeString('pt-BR', { hour: "2-digit", minute: "2-digit" });
          let place = ev.place && ev.place.trim() ? ev.place : "sem local definido";
          html += `<div class="event" data-id="${ev.id}">
            <span class="event-title">
              <span style="color: gray;">${startStr} - ${endStr}</span> | ${ev.title}
            </span>
            <div class="event-place">${place}</div>
          </div>`;
        }
        html += "</div>";
      }
      scheduleDiv.innerHTML = html || "<p>Nenhum evento corresponde ao filtro.</p>";

      document.querySelectorAll('.event').forEach(div => {
        div.onclick = () => {
          const eventId = Number(div.getAttribute('data-id'));
          const event = allEvents.find(e => e.id === eventId);
          showPopup(event);
        };
      });
    }

    function toLocal(isoString, timezone) {
      if (window.luxon) {
        return window.luxon.DateTime.fromISO(isoString, { zone: 'utc' }).setZone(timezone).toJSDate();
      } else {
        return new Date(isoString);
      }
    }

    function showPopup(ev) {
      if (!ev) return;
      let localStart = toLocal(ev.start_time, FIXED_TIMEZONE);
      let localEnd = toLocal(ev.end_time, FIXED_TIMEZONE);
      let dateStr = formatarDataPortugues(localStart);
      let startStr = localStart.toLocaleTimeString('pt-BR', { hour: "2-digit", minute: "2-digit" });
      let endStr = localEnd.toLocaleTimeString('pt-BR', { hour: "2-digit", minute: "2-digit" });

      let desc = ev.description && ev.description.trim() ? ev.description : "<em>Nenhuma descrição disponível.</em>";
      let place = ev.place && ev.place.trim() ? ev.place : "<em>sem local definido</em>";

      let speakersHtml = "";
      if (ev.speakers && ev.speakers.length) {
        speakersHtml = `<div class="popup-speakers"><strong>Palestrantes:</strong>`;
        for (const s of ev.speakers) {
          speakersHtml += `<div class="popup-speaker">`;
          if (s.picture) {
            speakersHtml += `<img class="popup-speaker-img" src="${s.picture}" alt="${s.name}">`;
          } else {
            speakersHtml += `<span class="popup-speaker-img" style="display:inline-block;background:#ccd;text-align:center;line-height:48px">${s.name ? s.name.charAt(0).toUpperCase() : '?'}</span>`;
          }
          speakersHtml += `<div class="popup-speaker-info">
            <div class="popup-speaker-name">${s.name}</div>
            ${s.role ? `<div>${s.role}</div>` : ""}
            ${s.company ? `<div>${s.company}</div>` : ""}
            ${s.bio ? `<div style="margin-top:0.3em">${s.bio}</div>` : ""}
          </div></div>`;
        }
        speakersHtml += `</div>`;
      }

      document.getElementById('popupTitle').innerHTML = ev.title;

      let popupHtml = `
        <div class="popup-time">${dateStr}, ${startStr} - ${endStr}</div>
        <div class="popup-place">${place}</div>
        <div class="popup-description">${desc}</div>
        ${speakersHtml}
      `;
      document.getElementById('popupContent').innerHTML = popupHtml;
      document.getElementById('popupOverlay').style.display = "flex";
    }
    document.getElementById("popupClose").onclick = function() {
      document.getElementById('popupOverlay').style.display = "none";
    };
    document.getElementById("popupOverlay").onclick = function(e) {
      if (e.target === this) this.style.display = "none";
    };

    // Async filter logic
    function filterAsync() {
      const args = [
        allEvents,
        parseTimeRange(document.getElementById("timeFilter").value),
        document.getElementById("dateFilter").value,
        document.getElementById("placeFilter").value,
        document.getElementById("searchInput").value
      ];
      scheduleFilterAsync(...args);
    }

    // Only one filter runs at a time; if another is requested during work, the latest wins.
    function scheduleFilterAsync(...args) {
      // If none is running, run now
      if (!filterTask) {
        filterTask = doFilterAsync(...args).then(() => {
          filterTask = null;
          // If new pending, run it (and clear pending)
          if (pendingFilter) {
            const next = pendingFilter;
            pendingFilter = null;
            scheduleFilterAsync(...next);
          }
        });
      } else {
        // Replace any pending filter with the latest request
        pendingFilter = args;
      }
    }

    async function doFilterAsync(...args) {
      // Artificially yield to simulate async, so UI events update
      await new Promise(r => setTimeout(r, 0));
      render(...args);
    }

    document.getElementById("filterBtn").onclick = function() {
      filterAsync();
    };
    document.getElementById("timeFilter").onkeydown = function(e) {
      if (e.key === "Enter") filterAsync();
    };
    document.getElementById("dateFilter").onchange = filterAsync;
    document.getElementById("placeFilter").onchange = filterAsync;
    document.getElementById("searchInput").oninput = filterAsync;

    (function addLuxonScript() {
      if (window.luxon) return;
      let s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js";
      s.onload = () => {
        updateDateDropdown(allEvents, FIXED_TIMEZONE);
        updatePlaceDropdown(allEvents);
        filterAsync();
      };
      document.head.appendChild(s);
    })();

    function dataHojePortugues() {
      const agora = new Date();
      let spDate;
      if (window.luxon) {
        spDate = window.luxon.DateTime.fromJSDate(agora).setZone(FIXED_TIMEZONE).toJSDate();
      } else {
        spDate = agora;
      }
      return formatarDataPortugues(spDate);
    }

    function updateDateDropdown(events, timezone) {
      let dateSel = document.getElementById("dateFilter");
      let daysSet = new Set();
      events.forEach(ev => {
        let localStart = toLocal(ev.start_time, timezone);
        let dayKey = formatarDataPortugues(localStart);
        daysSet.add(dayKey);
      });
      let daysArr = Array.from(daysSet).sort((a, b) => {
        let getDate = txt => {
          let partes = txt.split(' ');
          let dia = Number(partes[1]);
          let mes = mesesAno.indexOf(partes[3]);
          let ano = Number(partes[5]);
          return new Date(ano, mes, dia);
        };
        return getDate(a) - getDate(b);
      });

      let prev = dateSel.value;
      dateSel.innerHTML = `<option value="">Todas as Datas</option>`;
      daysArr.forEach(day => {
        let opt = document.createElement("option");
        opt.value = day;
        opt.textContent = day.charAt(0).toUpperCase() + day.slice(1);
        dateSel.appendChild(opt);
      });

      if (!prev || !daysArr.includes(prev)) {
        const hojeStr = dataHojePortugues();
        if (daysArr.includes(hojeStr)) {
          dateSel.value = hojeStr;
        } else {
          dateSel.value = "";
        }
      } else {
        dateSel.value = prev;
      }
    }

    function updatePlaceDropdown(events) {
      let placeSel = document.getElementById("placeFilter");
      let placesSet = new Set();
      events.forEach(ev => {
        let place = ev.place && ev.place.trim() ? ev.place.trim() : "sem local definido";
        placesSet.add(place);
      });
      let placesArr = Array.from(placesSet).sort((a, b) => a.localeCompare(b, 'pt-BR'));
      let prev = placeSel.value;
      placeSel.innerHTML = `<option value="">Todos os Lugares</option>`;
      placesArr.forEach(place => {
        let opt = document.createElement("option");
        opt.value = place;
        opt.textContent = place.charAt(0).toUpperCase() + place.slice(1);
        placeSel.appendChild(opt);
      });
      if (prev && placesArr.includes(prev)) placeSel.value = prev;
    }

    function setProgressBar(percent, msg) {
      const barContainer = document.getElementById('progress-bar-container');
      const bar = document.getElementById('progress-bar');
      const barMsg = document.getElementById('progress-msg');
      barContainer.style.display = 'block';
      barMsg.style.display = 'block';
      bar.style.width = percent + "%";
      barMsg.textContent = msg;
      if (percent >= 100) {
        setTimeout(() => {
          barContainer.style.display = 'none';
          barMsg.style.display = 'none';
        }, 600);
      }
    }

    function loadScheduleFromServer() {
      const status = document.getElementById('serverStatus');
      const loading = document.getElementById('loading');
      setProgressBar(0, "Baixando agenda...");
      loading.style.display = "block";
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'all_schedules.json', true);
      xhr.responseType = 'text';

      xhr.onprogress = function (e) {
        if (e.lengthComputable) {
          let percent = Math.round((e.loaded / e.total) * 100);
          setProgressBar(percent, `Baixando agenda... (${percent}%)`);
        } else {
          setProgressBar(50, "Baixando agenda...");
        }
      };
      xhr.onloadstart = function () {
        setProgressBar(0, "Baixando agenda...");
      };
      xhr.onerror = function () {
        setProgressBar(0, "Erro ao baixar agenda.");
        status.textContent = "Falha ao carregar all_schedules.json do servidor.";
        loading.style.display = "none";
      };
      xhr.onload = function () {
        setProgressBar(100, "Concluído!");
        loading.style.display = "none";
        if (xhr.status < 200 || xhr.status >= 300) {
          status.textContent = "Falha ao carregar all_schedules.json do servidor: HTTP " + xhr.status;
          return;
        }
        try {
          allEvents = JSON.parse(xhr.responseText);
          updateDateDropdown(allEvents, FIXED_TIMEZONE);
          updatePlaceDropdown(allEvents);
          filterAsync();
        } catch (e) {
          status.textContent = "Erro ao processar JSON da agenda: " + e;
        }
      };
      xhr.send();
    }

    loadScheduleFromServer();
  </script>
</body>
</html>
